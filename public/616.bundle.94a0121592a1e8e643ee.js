(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[616],{72776:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>M});const i=JSON.parse('{"u2":"@ohif/extension-cornerstone-dicom-seg"}').u2,a=`${i}.sopClassHandlerModule.dicom-seg`;var s=n(32735),o=n(92780),r=n(62771),l=n(22737);const{DicomMessage:c,DicomMetaDictionary:u}=l.default.data,m=["1.2.840.10008.5.1.4.1.1.66.4"];let g={};function d(e,t,n){const i=e[0],{StudyInstanceUID:s,SeriesInstanceUID:d,SOPInstanceUID:S,SeriesDescription:p,SeriesNumber:f,SeriesDate:b,SOPClassUID:I,wadoRoot:y,wadoUri:h,wadoUriRoot:D}=i,v={Modality:"SEG",loading:!1,isReconstructable:!0,displaySetInstanceUID:r.utils.guid(),SeriesDescription:p,SeriesNumber:f,SeriesDate:b,SOPInstanceUID:S,SeriesInstanceUID:d,StudyInstanceUID:s,SOPClassHandlerId:a,SOPClassUID:I,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,segments:{},sopClassUids:m,instance:i,instances:[i],wadoRoot:y,wadoUriRoot:D,wadoUri:h,isOverlayDisplaySet:!0},E=i.ReferencedSeriesSequence;if(!E)throw new Error("ReferencedSeriesSequence is missing for the SEG");const w=E[0];return v.referencedImages=i.ReferencedSeriesSequence.ReferencedInstanceSequence,v.referencedSeriesInstanceUID=w.SeriesInstanceUID,v.getReferenceDisplaySet=()=>{const{displaySetService:e}=t.services,n=e.getDisplaySetsForSeries(v.referencedSeriesInstanceUID);if(!n||0===n.length)throw new Error("Referenced DisplaySet is missing for the SEG");const i=n[0];v.referencedDisplaySetInstanceUID=i.displaySetInstanceUID,v.referencedVolumeURI=i.displaySetInstanceUID;const a=`cornerstoneStreamingImageVolume:${v.referencedVolumeURI}`;return v.referencedVolumeId=a,i},v.load=async e=>{let{headers:i}=e;return await function(e,t,n,i){const{SOPInstanceUID:a}=e,{segmentationService:s}=t.services;if((e.loading||e.isLoaded)&&g[a]&&function(e,t){return t.getSegmentation(e.displaySetInstanceUID)}(e,s))return g[a];return e.loading=!0,g[a]=new Promise((async(t,a)=>{if(!e.segments||0===Object.keys(e.segments).length){const t=await async function(e,t,n){const i=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{dicomLoaderService:a}=i.exports,s=await a.findDicomDataPromise(t,null,n),r=c.readFile(s),m=u.naturalizeDataset(r.dict);m._meta=u.namifyDataset(r.meta),Array.isArray(m.SegmentSequence)||(m.SegmentSequence=[m.SegmentSequence]);const g=function(e){const t={};return e.SegmentSequence.forEach((e=>{const n=e.RecommendedDisplayCIELabValue,i=l.default.data.Colors.dicomlab2RGB(n).map((e=>Math.round(255*e)));i.push(255);const a=e.SegmentNumber;t[a]={color:i,functionalGroups:[],offset:null,size:null,pixelData:null,label:e.SegmentLabel}})),e.PerFrameFunctionalGroupsSequence.forEach((e=>{const n=e.SegmentIdentificationSequence.ReferencedSegmentNumber;t[n].functionalGroups.push(e)})),function(e,t){let n=Math.ceil(e.Rows*e.Columns/8),i=0;return Object.keys(t).forEach((a=>{const s=t[a];s.numberOfFrames=s.functionalGroups.length,s.size=s.numberOfFrames*n,s.offset=i,i=s.offset+s.size;const r=e.PixelData[0].slice(s.offset,i);s.pixelData=l.default.data.BitArray.unpack(r),s.geometry=function(e,t){let n=e.SharedFunctionalGroupsSequence.PixelMeasuresSequence,i=e.SharedFunctionalGroupsSequence.PlaneOrientationSequence,a=t[0].PlanePositionSequence;const s={};let r=n.SpacingBetweenSlices;r||n.SliceThickness&&(console.log("Using SliceThickness as SpacingBetweenSlices"),r=n.SliceThickness);s.spacing=[n.PixelSpacing[1],n.PixelSpacing[0],r].map(Number),s.dimensions=[e.Columns,e.Rows,t.length].map(Number);let l=i.ImageOrientationPatient.map(Number);const c=l.slice(0,3),u=l.slice(3,6);s.planeNormal=[],o.ZP.cross(c,u,s.planeNormal);let m=t[0].PlanePositionSequence.ImagePositionPatient.map(Number),g=t[t.length-1].PlanePositionSequence.ImagePositionPatient.map(Number);return s.sliceStep=[],o.ZP.subtract(g,m,s.sliceStep),o.ZP.normalize(s.sliceStep),s.direction=c.concat(u).concat(s.sliceStep),s.origin=a.ImagePositionPatient.map(Number),s}(e,s.functionalGroups)})),t}(e,t)}(m);return g}(n,e,i);e.segments=t}const r=!0;s.createSegmentationForSEGDisplaySet(e,null,r).then((()=>{e.loading=!1,t()})).catch((t=>{e.loading=!1,a(t)}))})),g[a]}(v,t,n,i)},[v]}const S=function(e){let{servicesManager:t,extensionManager:n}=e;return[{name:"dicom-seg",sopClassUids:m,getDisplaySetsFromSeries:e=>d(e,t,n)}]};var p=n(60216),f=n.n(p),b=n(28619);const I=function(e,t,n){const i="enter-segment-label",a=t=>{let{action:a,value:s}=t;switch(a.id){case"save":n(s.label,a.id);break;case"cancel":n("",a.id)}e.dismiss({id:i})};e&&e.create({id:i,centralize:!0,isDraggable:!1,showOverlay:!0,content:b.Vq,contentProps:{title:"Segment",value:{label:t},noCloseButton:!0,onClose:()=>e.dismiss({id:i}),actions:[{id:"cancel",text:"Cancel",type:b.LZ.U.secondary},{id:"save",text:"Confirm",type:b.LZ.U.primary}],onSubmit:a,body:e=>{let{value:t,setValue:n}=e;return s.createElement(b.II,{label:"Enter the segment label",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,className:"bg-black border-primary-main",type:"text",value:t.label,onChange:e=>{e.persist(),n((t=>({...t,label:e.target.value})))},onKeyPress:e=>{"Enter"===e.key&&a({value:t,action:{id:"save"}})}})}}})};var y=n(21572);function h(e){let{servicesManager:t,commandsManager:n}=e;const{segmentationService:i,uiDialogService:a}=t.services,{t:o}=(0,y.$G)("PanelSegmentation"),[r,l]=(0,s.useState)(null),[c,u]=(0,s.useState)(i.getConfiguration()),[m,g]=(0,s.useState)((()=>i.getSegmentations())),[d,S]=(0,s.useState)({}),p=(0,s.useCallback)((e=>{S((t=>({...t,[e]:!t[e]})))}),[S]);(0,s.useEffect)((()=>{const e=m[m.length-1]?.id;e&&S((t=>({...t,[e]:!1})))}),[m,S]),(0,s.useEffect)((()=>{const e=i.EVENTS.SEGMENTATION_ADDED,t=i.EVENTS.SEGMENTATION_UPDATED,n=i.EVENTS.SEGMENTATION_REMOVED,a=[];return[e,t,n].forEach((e=>{const{unsubscribe:t}=i.subscribe(e,(()=>{const e=i.getSegmentations();g(e),u(i.getConfiguration())}));a.push(t)})),()=>{a.forEach((e=>{e()}))}}),[]);const f=e=>i.getToolGroupIdsWithSegmentation(e),h=(0,s.useCallback)(((e,t,n)=>{i.setConfiguration({segmentationId:e,[t]:n})}),[i]);return s.createElement("div",{className:"flex flex-col flex-auto min-h-0 justify-between mt-1"},m?.length?s.createElement(b.cX,{title:o("Segmentations"),showAddSegmentation:!1,segmentations:m,isMinimized:d,activeSegmentationId:r||"",onSegmentationClick:e=>{i.setActiveSegmentationForToolGroup(e)},onSegmentationDelete:e=>{i.remove(e)},onSegmentationEdit:e=>{const t=i.getSegmentation(e),{label:n}=t;I(a,n,((t,n)=>{""!==t&&i.addOrUpdateSegmentation({id:e,label:t},!1,!0)}))},onSegmentClick:(e,t)=>{i.setActiveSegmentForSegmentation(e,t);f(e).forEach((n=>{i.setActiveSegmentationForToolGroup(e,n),i.jumpToSegmentCenter(e,t,n)}))},onSegmentEdit:(e,t)=>{const n=i.getSegmentation(e).segments[t],{label:s}=n;I(a,s,((n,a)=>{""!==n&&i.setSegmentLabelForSegmentation(e,t,n)}))},onSegmentColorClick:(e,t)=>{},onSegmentDelete:(e,t)=>{console.warn("not implemented yet")},onToggleSegmentVisibility:(e,t)=>{const n=!i.getSegmentation(e).segments[t].isVisible;f(e).forEach((a=>{i.setSegmentVisibility(e,t,n,a)}))},onToggleSegmentationVisibility:e=>{i.toggleSegmentationVisibility(e)},onToggleMinimizeSegmentation:p,segmentationConfig:{initialConfig:c},setRenderOutline:e=>h(r,"renderOutline",e),setOutlineOpacityActive:e=>h(r,"outlineOpacity",e),setRenderFill:e=>h(r,"renderFill",e),setRenderInactiveSegmentations:e=>h(r,"renderInactiveSegmentations",e),setOutlineWidthActive:e=>h(r,"outlineWidthActive",e),setFillAlpha:e=>h(r,"fillAlpha",e),setFillAlphaInactive:e=>h(r,"fillAlphaInactive",e)}):null)}h.propTypes={commandsManager:f().shape({runCommand:f().func.isRequired}),servicesManager:f().shape({services:f().shape({segmentationService:f().shape({getSegmentation:f().func.isRequired,getSegmentations:f().func.isRequired,toggleSegmentationVisibility:f().func.isRequired,subscribe:f().func.isRequired,EVENTS:f().object.isRequired}).isRequired}).isRequired}).isRequired};const D={id:"@ohif/seg",hasUpdatedPriorsInformation:!1,name:"Segmentations",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{segDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SEG"}}]}},stages:[{name:"Segmentations",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId"}]}]}]};const v=function(){return[{name:D.id,protocol:D}]};function E(){return E=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},E.apply(this,arguments)}const w=s.lazy((()=>n.e(569).then(n.bind(n,33569)))),P=e=>s.createElement(s.Suspense,{fallback:s.createElement("div",null,"Loading...")},s.createElement(w,e)),M={id:i,getPanelModule:e=>{let{servicesManager:t,commandsManager:n,extensionManager:i}=e;return[{name:"panelSegmentation",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:()=>s.createElement(h,{commandsManager:n,servicesManager:t,extensionManager:i})}]},getViewportModule(e){let{servicesManager:t,extensionManager:n}=e;return[{name:"dicom-seg",component:e=>s.createElement(P,E({servicesManager:t,extensionManager:n},e))}]},getSopClassHandlerModule:S,getHangingProtocolModule:v}},78753:()=>{}}]);
//# sourceMappingURL=616.bundle.94a0121592a1e8e643ee.js.map